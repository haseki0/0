<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayıtlar - 3 Sütun</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #2c3e50, #34495e);
            --success-gradient: linear-gradient(135deg, #27ae60, #229954);
            --danger-gradient: linear-gradient(135deg, #e74c3c, #c0392b);
            --warning-gradient: linear-gradient(135deg, #f39c12, #e67e22);
            --info-gradient: linear-gradient(135deg, #3498db, #2980b9);
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.15);
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 15px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 10px;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header {
            background: var(--secondary-gradient);
            color: white;
            padding: 24px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-call-display {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 12px 20px;
            border-radius: var(--border-radius-md);
            font-size: 18px;
            font-weight: 700;
            border: 2px solid rgba(231, 76, 60, 0.3);
            animation: pulse-glow 2s infinite;
            display: none;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
        }

        .current-call-display.active {
            display: flex;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 25px;
            min-height: 80vh;
        }

        .column {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            color: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .column-header.range-100 { background: var(--info-gradient); }
        .column-header.range-200 { background: var(--warning-gradient); }
        .column-header.range-300 { background: var(--danger-gradient); }

        .add-record-btn {
            position: absolute;
            right: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 14px;
            font-weight: 500;
        }

        .add-record-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .records-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .records-container::-webkit-scrollbar {
            width: 6px;
        }

        .records-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .record-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .record-card.range-100 { border-left-color: #3498db; }
        .record-card.range-200 { border-left-color: #f39c12; }
        .record-card.range-300 { border-left-color: #e74c3c; }

        .record-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .record-card.editing {
            border: 2px solid #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .record-card.permanently-called {
            opacity: 0.4;
            filter: grayscale(70%);
            transform: scale(0.98);
            border: 2px solid #95a5a6;
            background: #f8f9fa;
        }

        .record-card.calling {
            border: 3px solid #e74c3c;
            animation: calling-pulse 2s infinite;
        }

        @keyframes calling-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        .record-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .record-number {
            font-size: 18px;
            font-weight: 700;
            color: white;
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            flex-shrink: 0;
        }

        .record-card.range-100 .record-number { background: #3498db; }
        .record-card.range-200 .record-number { background: #f39c12; }
        .record-card.range-300 .record-number { background: #e74c3c; }
        .record-card.permanently-called .record-number { background: #95a5a6 !important; }

        .record-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: var(--transition-normal);
        }

        .record-card:hover .record-actions {
            opacity: 1;
        }

        .record-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .record-process {
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.4;
            background: var(--bg-secondary);
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            border-left: 2px solid currentColor;
            flex: 1;
        }

        .call-button {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
        }

        .call-button.active { background: var(--danger-gradient); }
        .call-button.called { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

        .reset-call-btn {
            background: var(--warning-gradient);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .reset-call-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: var(--transition-fast);
            font-size: 12px;
        }

        .action-btn.edit:hover { color: #3498db; }
        .action-btn.delete:hover { color: #e74c3c; }

        .no-records {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px 15px;
            background: var(--bg-primary);
            border-radius: var(--border-radius-md);
            border: 2px dashed var(--border-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-primary);
            margin: 8% auto;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition-normal);
            background: var(--bg-secondary);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: var(--bg-primary);
        }

        .btn {
            background: var(--info-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition-normal);
            margin: 6px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-success { background: var(--success-gradient); }

        .clear-call-btn {
            background: var(--danger-gradient);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .clear-call-btn.active { display: flex; }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 16px;
            border-radius: var(--border-radius-md);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .date-filter i {
            color: white;
            font-size: 16px;
        }

        .date-filter input[type="date"] {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .date-filter input[type="date"]:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .filter-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 14px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: repeat(2, 1fr);
            }
            .column:last-child {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-columns"></i>
                    <span>Kayıtlar - 3 Sütun Görünümü</span>
                </h1>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div class="date-filter">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="dateFilter" onchange="filterByDate()">
                        <button class="filter-btn" onclick="resetFilter()">
                            <i class="fas fa-redo"></i> Tümü
                        </button>
                    </div>
                    <div class="current-call-display" id="currentCallDisplay">
                        <i class="fas fa-volume-up"></i>
                        <span>Çağrılan: <strong id="currentCallNumber">-</strong></span>
                    </div>
                    <button class="clear-call-btn" id="clearCallBtn" onclick="clearCurrentCall()">
                        <i class="fas fa-stop"></i> Çağrıyı Durdur
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="column">
                <div class="column-header range-100">
                    <i class="fas fa-user-md"></i>
                    <span>Doktor İşlemleri</span>
                    <button class="add-record-btn" onclick="showAddModal('100')">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
                <div class="records-container" id="records-100">
                    <div class="no-records">
                        <i class="fas fa-inbox"></i>
                        <div>Henüz kayıt yok</div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header range-200">
                    <i class="fas fa-stethoscope"></i>
                    <span>Kontrol ve Muayeneler</span>
                    <button class="add-record-btn" onclick="showAddModal('200')">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
                <div class="records-container" id="records-200">
                    <div class="no-records">
                        <i class="fas fa-inbox"></i>
                        <div>Henüz kayıt yok</div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header range-300">
                    <i class="fas fa-band-aid"></i>
                    <span>Dikiş Ve Pansuman İşlemleri</span>
                    <button class="add-record-btn" onclick="showAddModal('300')">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
                <div class="records-container" id="records-300">
                    <div class="no-records">
                        <i class="fas fa-inbox"></i>
                        <div>Henüz kayıt yok</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="recordModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> Yeni Kayıt Ekle</h3>
            <form id="recordForm">
                <div class="form-group">
                    <label for="recordNumber">Sıra Numarası</label>
                    <input type="number" id="recordNumber" required>
                </div>
                <div class="form-group">
                    <label for="recordClinic">Poliklinik</label>
                    <select id="recordClinic" required>
                        <option value="">Seçiniz...</option>
                        <option value="Genel Cerrahi Polikliniği 1">Genel Cerrahi Polikliniği 1</option>
                        <option value="Genel Cerrahi Polikliniği 2">Genel Cerrahi Polikliniği 2</option>
                        <option value="Genel Cerrahi Polikliniği 3">Genel Cerrahi Polikliniği 3</option>
                        <option value="Obezite Cerrahisi Polikliniği">Obezite Cerrahisi Polikliniği</option>
                        <option value="Endokrin Cerrahisi Polikliniği">Endokrin Cerrahisi Polikliniği</option>
                        <option value="Meme Cerrahisi Polikliniği">Meme Cerrahisi Polikliniği</option>
                        <option value="HPB+GİS Polikliniği">HPB+GİS Polikliniği</option>
                        <option value="Plastik Cerrahi Polikliniği">Plastik Cerrahi Polikliniği</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recordProcess">İşlem</label>
                    <textarea id="recordProcess" placeholder="İşlem açıklaması..." required></textarea>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> <span id="saveButtonText">Kaydet</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">
                        <i class="fas fa-times"></i> İptal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBoiZFdN-elWsn0LEeT-YdZnOcrbYCrCeI",
            authDomain: "yeniboard-af11c.firebaseapp.com",
            projectId: "yeniboard-af11c",
            storageBucket: "yeniboard-af11c.firebasestorage.app",
            messagingSenderId: "661813442383",
            appId: "1:661813442383:web:f2fccb4dca2e9788cc373a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let unsubscribeListener = null;
        let editingRecordId = null;
        let currentCallSequence = null;
        let allRecords = [];
        let selectedDate = null;

        document.addEventListener('DOMContentLoaded', () => {
            setTodayDate();
            setupRealtimeListener();
            setupFormHandler();
            loadCurrentCall();
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
            selectedDate = today;
        }

        function filterByDate() {
            const dateInput = document.getElementById('dateFilter').value;
            selectedDate = dateInput;
            displayRecordsByRange(allRecords);
        }

        function resetFilter() {
            selectedDate = null;
            document.getElementById('dateFilter').value = '';
            displayRecordsByRange(allRecords);
        }

        function setupRealtimeListener() {
            if (unsubscribeListener) unsubscribeListener();
            
            unsubscribeListener = db.collection('processes')
                .orderBy('timestamp', 'desc')
                .limit(200)
                .onSnapshot(snapshot => {
                    allRecords = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        date: doc.data().timestamp?.toDate().toISOString()
                    }));
                    displayRecordsByRange(allRecords);
                }, error => {
                    console.error('Listener error:', error);
                    loadRecordsOnce();
                });
        }

        function loadRecordsOnce() {
            db.collection('processes')
                .orderBy('timestamp', 'desc')
                .limit(200)
                .get()
                .then(snapshot => {
                    allRecords = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        date: doc.data().timestamp?.toDate().toISOString()
                    }));
                    displayRecordsByRange(allRecords);
                });
        }

        function getRange(sequenceNumber) {
            const num = parseInt(sequenceNumber.split('-')[1] || sequenceNumber);
            if (num >= 100 && num <= 199) return '100';
            if (num >= 200 && num <= 299) return '200';
            if (num >= 300 && num <= 499) return '300';
            return null;
        }

        function displayRecordsByRange(records) {
            const containers = {
                '100': document.getElementById('records-100'),
                '200': document.getElementById('records-200'),
                '300': document.getElementById('records-300')
            };

            // Tarihe göre filtrele
            let filteredRecords = records;
            if (selectedDate) {
                filteredRecords = records.filter(rec => {
                    if (!rec.date) return false;
                    const recDate = new Date(rec.date).toISOString().split('T')[0];
                    return recDate === selectedDate;
                });
            }

            const grouped = { '100': [], '200': [], '300': [] };
            filteredRecords.forEach(rec => {
                const range = getRange(rec.sequenceNumber);
                if (range) grouped[range].push(rec);
            });

            Object.keys(containers).forEach(range => {
                if (grouped[range].length > 0) {
                    containers[range].innerHTML = grouped[range]
                        .map((rec, i) => createRecordCardHTML(rec, range, i))
                        .join('');
                } else {
                    const filterMsg = selectedDate ? 'Bu tarihte kayıt yok' : 'Henüz kayıt yok';
                    containers[range].innerHTML = `
                        <div class="no-records">
                            <i class="fas fa-inbox"></i>
                            <div>${filterMsg}</div>
                        </div>`;
                }
            });
        }

        function createRecordCardHTML(rec, range, index) {
            const date = new Date(rec.date);
            const formattedDate = date.toLocaleString('tr-TR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
            const seqOnly = rec.sequenceNumber.split('-')[1] || rec.sequenceNumber;

            let cardClass = `record-card range-${range}`;
            let btnText = 'Çağır', btnIcon = 'fas fa-bell', btnClass = 'call-button';

            if (rec.isCalled) {
                cardClass += ' permanently-called';
                btnText = 'Çağrıldı';
                btnIcon = 'fas fa-check';
                btnClass += ' called';
            }

            if (currentCallSequence === seqOnly) {
                cardClass += ' calling';
                btnText = 'Çağrılıyor...';
                btnIcon = 'fas fa-volume-up';
                btnClass += ' active';
            }

            return `
                <div class="${cardClass}" data-id="${rec.id}">
                    <div class="record-header">
                        <div class="record-number">${seqOnly}</div>
                        <div class="record-actions">
                            <button class="action-btn edit" onclick="editRecord('${rec.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteRecord('${rec.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="record-info-row">
                        <div><i class="fas fa-clock"></i> ${formattedDate}</div>
                        <div><i class="fas fa-hospital"></i> ${rec.user}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="record-process">${rec.process}</div>
                        <button class="${btnClass}" onclick="toggleCall('${seqOnly}', '${rec.id}')" data-sequence="${seqOnly}" data-record-id="${rec.id}">
                            <i class="${btnIcon}"></i> ${btnText}
                        </button>
                        ${rec.isCalled ? `<button class="reset-call-btn" onclick="resetCallStatus('${rec.id}')" title="Hastayı geri al"><i class="fas fa-undo"></i></button>` : ''}
                    </div>
                </div>`;
        }

        function toggleCall(seqNum, recId) {
            const ref = db.collection('hastapanel').doc('hastapanel');
            
            if (currentCallSequence === seqNum) {
                ref.set({ cagrisirasi: null, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            } else {
                Promise.all([
                    ref.set({ cagrisirasi: seqNum, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }),
                    db.collection('processes').doc(recId).update({
                        isCalled: true,
                        calledAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                ]);
            }
        }

        function resetCallStatus(recId) {
            if (confirm('Bu hastanın durumunu sıfırlamak istediğinizden emin misiniz? Hasta tekrar çağrılabilir hale gelecek.')) {
                db.collection('processes').doc(recId).update({
                    isCalled: false,
                    calledAt: null
                }).then(() => {
                    console.log('Call status reset successfully');
                }).catch(error => {
                    console.error('Error resetting call status:', error);
                });
            }
        }

        function clearCurrentCall() {
            if (currentCallSequence) {
                // Mevcut çağrılan hastanın kaydını bul
                const currentRecord = allRecords.find(rec => {
                    const seqOnly = rec.sequenceNumber.split('-')[1] || rec.sequenceNumber;
                    return seqOnly === currentCallSequence;
                });

                // Çağrıyı durdur ve hastanın durumunu sıfırla
                const promises = [
                    db.collection('hastapanel').doc('hastapanel')
                        .set({ cagrisirasi: null, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true })
                ];

                // Eğer kayıt bulunduysa, onun da isCalled durumunu false yap
                if (currentRecord && currentRecord.id) {
                    promises.push(
                        db.collection('processes').doc(currentRecord.id).update({
                            isCalled: false,
                            calledAt: null
                        })
                    );
                }

                Promise.all(promises).then(() => {
                    console.log('Call cleared and status reset');
                }).catch(error => {
                    console.error('Error clearing call:', error);
                });
            }
        }

        function loadCurrentCall() {
            db.collection('hastapanel').doc('hastapanel').onSnapshot(doc => {
                currentCallSequence = doc.exists ? doc.data()?.cagrisirasi : null;
                updateHeaderDisplay();
                updateCallButtons();
            });
        }

        function updateHeaderDisplay() {
            const display = document.getElementById('currentCallDisplay');
            const num = document.getElementById('currentCallNumber');
            const btn = document.getElementById('clearCallBtn');
            
            if (currentCallSequence) {
                display.classList.add('active');
                btn.classList.add('active');
                num.textContent = currentCallSequence;
            } else {
                display.classList.remove('active');
                btn.classList.remove('active');
                num.textContent = '-';
            }
        }

        function updateCallButtons() {
            document.querySelectorAll('.call-button').forEach(btn => {
                const seq = btn.dataset.sequence;
                const card = btn.closest('.record-card');
                
                if (seq === currentCallSequence) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> Çağrılıyor...';
                    card.classList.add('calling');
                } else if (card.classList.contains('permanently-called')) {
                    btn.classList.add('called');
                    btn.innerHTML = '<i class="fas fa-check"></i> Çağrıldı';
                } else {
                    btn.classList.remove('active', 'called');
                    btn.innerHTML = '<i class="fas fa-bell"></i> Çağır';
                    card.classList.remove('calling');
                }
            });
        }

        function showAddModal(range) {
            editingRecordId = null;
            document.getElementById('modalTitle').innerHTML = `<i class="fas fa-plus-circle"></i> Yeni Kayıt Ekle`;
            document.getElementById('recordForm').reset();
            
            const input = document.getElementById('recordNumber');
            if (range === '100') { input.min = 100; input.max = 199; }
            else if (range === '200') { input.min = 200; input.max = 299; }
            else { input.min = 300; input.max = 499; }
            
            document.getElementById('recordModal').style.display = 'block';
        }

        function editRecord(id) {
            db.collection('processes').doc(id).get().then(doc => {
                if (doc.exists) {
                    const rec = doc.data();
                    editingRecordId = id;
                    document.getElementById('recordNumber').value = rec.sequenceNumber.split('-')[1] || rec.sequenceNumber;
                    document.getElementById('recordClinic').value = rec.user;
                    document.getElementById('recordProcess').value = rec.process;
                    document.getElementById('modalTitle').innerHTML = `<i class="fas fa-edit"></i> Kayıt Düzenle`;
                    document.getElementById('saveButtonText').textContent = 'Güncelle';
                    document.getElementById('recordModal').style.display = 'block';
                    document.querySelector(`[data-id="${id}"]`)?.classList.add('editing');
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Bu kaydı silmek istediğinizden emin misiniz?')) {
                db.collection('processes').doc(id).delete();
            }
        }

        function hideModal() {
            document.getElementById('recordModal').style.display = 'none';
            document.querySelectorAll('.editing').forEach(el => el.classList.remove('editing'));
            editingRecordId = null;
        }

        function getCurrentDateKey() {
            const now = new Date();
            return `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getFullYear()).slice(-2)}`;
        }

        function setupFormHandler() {
            document.getElementById('recordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const number = document.getElementById('recordNumber').value;
                const clinic = document.getElementById('recordClinic').value;
                const process = document.getElementById('recordProcess').value;

                if (!number || !clinic || !process) return;

                const dateKey = getCurrentDateKey();
                const sequenceNumber = `${dateKey}-${number}`;

                const recordData = {
                    user: clinic,
                    process: process,
                    sequenceNumber: sequenceNumber,
                    date: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    dateKey: dateKey,
                    prefix: getPrefix(number),
                    isCalled: false
                };

                try {
                    if (editingRecordId) {
                        delete recordData.isCalled;
                        await db.collection('processes').doc(editingRecordId).update(recordData);
                    } else {
                        await db.collection('processes').add(recordData);
                    }
                    hideModal();
                } catch (error) {
                    console.error('Save error:', error);
                }
            });
        }

        function getPrefix(number) {
            const num = parseInt(number);
            if (num >= 100 && num <= 199) return '110';
            if (num >= 200 && num <= 299) return '210';
            return '310';
        }

        window.onclick = (e) => {
            if (e.target === document.getElementById('recordModal')) hideModal();
        };

        window.addEventListener('beforeunload', () => {
            if (unsubscribeListener) unsubscribeListener();
        });
    </script>
</body>
</html>
